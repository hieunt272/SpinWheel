@model SpinWheel.ViewModel.EventViewModel

@Html.HiddenFor(model => model.Event.Url)
<div class="wrapper row m-0">
    <div class="col-lg-6 col-12 d-flex justify-content-center">
        <div class="card-info">
            <div class="card-header">
                XÁC NHẬN THÔNG TIN
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Họ tên: <span id="fullname"></span></li>
                <li class="list-group-item">Số điện thoại: <span id="phone"></span></li>
            </ul>
        </div>
    </div>
    <div class="col-lg-6 col-12">
        <div class="mainbox">
            <canvas id="canvas"
                    width="600"
                    height="600"
                    data-responsiveMinWidth="180"
                    data-responsiveScaleHeight="true"
                    data-responsiveMargin="50">
                <p style="color: white">
                    Sorry, your browser doesn't support canvas.
                    Please try another.
                </p>
            </canvas>
            <div class="border-spin"></div>
            <div class="start-spin" onclick="startSpin()">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="Modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <h5 class="modal-title">Mời bạn nhập thông tin</h5>
            <div class="modal-body text-center">
                <form id="info-form">
                    @Html.ValidationSummary(true)
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="eventId" value="@Model.Event.Id" />
                    <input type="text" class="form-control mx-auto" name="fullname" placeholder="Họ và tên" />
                    @Html.TextBoxFor(a => Model.Client.Mobile, new { @placeholder = "Số điện thoại", @class = "form-control my-3 mx-auto" })
                    @Html.ValidationMessageFor(a => Model.Client.Mobile)
                    <button type="submit" class="btn btn-confirm">Xác nhận</button>
                    <button type="button" class="btn btn-close" onclick="closeModal()">Đóng</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        var gifts = [];

        var url = $("#Event_Url").val();
        $.getJSON("/Home/GetAwardData", { url: url }, function (data) {
            $.each(data, function (key, val) {
                var percent = winwheelPercentToDegrees(val.percent);
                if (percent === 0) {
                    theWheel.addSegment({
                        'text': val.name,
                        'fillStyle': val.bgColor,
                        'textFillStyle': val.txtColor,
                        //'lineWidth': 0,
                        //'strokeStyle': 'transparent',
                        'quantity': val.quantity,
                        'totalwin': val.totalWin,
                        'id': val.id,
                    }, 1);
                }
                else {
                    theWheel.addSegment({
                        'text': val.name,
                        'fillStyle': val.bgColor,
                        'textFillStyle': val.txtColor,
                        //'lineWidth': 0,
                        //'strokeStyle': 'transparent',
                        'size': percent,
                        'quantity': val.quantity,
                        'totalwin': val.totalWin,
                        'id': val.id,
                    }, 1);
                }
            });
        });
        function ChangeBackground(x) {
            $.getJSON("/Home/GetAwardData", { url: url }, function (data) {
                $.each(data, function (key, val) {
                    if (x.matches) {
                        $(".wrapper").css("background", "url(images/events/" + val.bgMobile + ") no-repeat top center / 100% 100%");
                    }
                    else {
                        $(".wrapper").css("background", "url(images/events/" + val.bgPc + ") no-repeat top center / 100% 100%");
                    }
                });
            });
        }
        var x = window.matchMedia("(max-width: 840px)");
        ChangeBackground(x);
        x.addListener(ChangeBackground);

        const theWheel = new Winwheel({
            numSegments: gifts.length,
            segments: gifts,
            outerRadius: 300,
            textFontSize: 18,
            responsive: true,
            animation: {
                type: "spinToStop",
                duration: 5,
                spins: 15,
                //callbackSound: playSound,
                callbackFinished: alertPrize,
            }
        });
        //let ding = new Audio("./content/sound/applause.mp3");
        //let applause = new Audio("./content/sound/ding.mp3");

        //function playSound() {
        //    ding.pause();
        //    ding.currentTime = 0;
        //    ding.play();
        //}

        let wheelSpinning = false;

        function StatusButton(status) {
            if (status == 1) {
                document
                    .querySelector(".border-spin")
                    .removeAttribute("disabled");
            } else if (status == 2) {
                document
                    .querySelector(".border-spin")
                    .setAttribute("disabled", false);
            } else if (status == 3) {
                document
                    .querySelector(".border-spin")
                    .removeAttribute("disabled");

                theWheel.stopAnimation(false);
                theWheel.rotationAngle = 0;
                theWheel.draw();

                wheelSpinning = false;
            }
        }
        StatusButton(1);

        $("#info-form").on("submit", function (e) {
            e.preventDefault();
            var fullName = $("[name=fullname]").val();
            var phone = $("#Client_Mobile").val();
            var checkPhone = /^\(?(09|03|07|08|05)\)?[-. ]?([0-9]{8})$/;
            if (fullName == "" || phone == "") {
                Swal.fire({
                    icon: "warning",
                    text: "Vui lòng nhập đủ thông tin",
                });
            }
            else if (phone.match(checkPhone)) { 
                $("#Modal").modal('hide');
                $(".card-info").addClass("active");
                $("#fullname").text(fullName);
                $("#phone").text(phone);
            }
        });

        function startSpin() {
            var phone = $("#Client_Mobile").val();
            var fullName = $("[name=fullname]").val();
            var eventId = $("[name=eventId]").val();
            var isPost = true;

            if (fullName == "" || phone == "") {
                $('#Modal').modal('show');
            }

            if (phone == "") {
                isPost = false;
            }
            if (isPost) {
                $.getJSON("/Home/GetClientData", { phone: phone, eventId: eventId }, function (data) {
                    if (data == 1) {
                        if (wheelSpinning == false) {
                            StatusButton(1);
                            theWheel.startAnimation();
                            wheelSpinning = true;
                            StatusButton(2);
                        }
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            text: 'Số lượt quay trong ngày đã hết!!',
                            confirmButtonText: "Nhập lại thông tin",
                            confirmButtonColor: "#3085d6",
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        });
                    }
                });
            }
        }

        function alertPrize() {
            //applause.play();
            let winningSegment = theWheel.getIndicatedSegment();
            const quantity = parseInt(winningSegment.quantity);
            const totalWin = parseInt(winningSegment.totalwin);
            if (quantity <= totalWin) {
                Swal.fire({
                    title: "Số lượng giải <span>" + winningSegment.text + "</span> đã hết",
                    text: "Bạn có 1 lượt quay mới",
                    icon: "warning",
                    confirmButtonText: "Xác nhận",
                    confirmButtonColor: "#218838",
                }).then((result) => {
                    StatusButton(3);
                });
            }
            else {
                Swal.fire({
                    title: "Chúc mừng",
                    text: "Bạn đã trúng: " + winningSegment.text,
                    icon: "success",
                });
                var fullName = $("[name=fullname]").val();
                var phone = $("#Client_Mobile").val();
                $.post("/Home/InfoForm", { phone: phone, fullName: fullName, prize: winningSegment.text, awardId: winningSegment.id }, function (data) {
                })

                StatusButton(3);
            }
        }

        $('.modal').click(function () {
            $("#info-form").trigger("reset");
        });

        $('.modal-content').click(function (e) {
            e.stopImmediatePropagation();
        });

        function closeModal() {
            $('#Modal').modal('hide');
        }
    </script>
}